|             |                                       |
| :---------- | :------------------------------------ |
| **Feature** | AWS Encryption SDK Message Encryption |
| **Version** | 2                                     |
| **Created** | 2016-06-25                            |
| **Updated** | 2021-05-03                            |

## Dependencies

This serves as a reference of all features that this feature depends on.

| Feature                                             | Min Version | Max Version |
| --------------------------------------------------- | ----------- | ----------- |
| [0002-keys](./0002-keys.md)                         | 1           | n/a         |
| [0005-awses-master-key](./0005-awses-master-key.md) | 1           | n/a         |

## Supported Implementations

This serves as a references for which implementations support this feature. A minimum of two supporting implementations
are required for new feature versions.

| Repository                                                                                   | Language             | Feature Version                   | Minimum Version                                              | Pull Request                    |
| -------------------------------------------------------------------------------------------- | -------------------- | --------------------------------- | ------------------------------------------------------------ | ------------------------------- |
| https://github.com/aws/aws-encryption-sdk-python/tree/master/test_vector_handlers            | Python               | 2                                 | https://github.com/aws/aws-encryption-sdk-python/pull/63     |
| https://github.com/aws/aws-encryption-sdk-javascript/tree/master/modules/integration-node    | Javascript (Node.js) | 2                                 | https://github.com/aws/aws-encryption-sdk-javascript/pull/67 |
| https://github.com/aws/aws-encryption-sdk-javascript/tree/master/modules/integration-browser | Javascript (Browser) | 2                                 | https://github.com/aws/aws-encryption-sdk-javascript/pull/68 |
| Link to GitHub repository                                                                    | Language             | Supported version of this feature | Minimum version that supports this feature version           | Pull request that added support |

## Summary

An AWS Encryption SDK Message Encryption manifest defines static test vectors for full ciphertext
message encryption. This includes all necessary details such as master key(s), encryption
context, algorithm suite, and frame size.

## Out of Scope

This file is not a description of how the test vectors that will be generated by a compatible
client should be decrypted.

## Motivation

We need a way of describing all scenarios that we want to cover with test vectors for full AWS
Encryption SDK ciphertext messages. This will be used for generating test vectors with an
unknown implementation to be tested for compatibility using a known good implementation.

Note that generating known good decryption test vectors with a known good implementation is no longer in scope
for this kind of manifest. That scope has been moved to the
[0006-awses-message-decryption-generation](0006-awses-message-decryption-generation.md) feature instead.

## Guide-level Explanation

This type of manifest describes test vectors to create. Processing these test scenarios will result
in complete AWS Encryption SDK ciphertext messages.

Each test scenario includes all necessary instructions to construct a ciphertext message. This includes
all necessary inputs including algorithm suite, frame size, encryption context, and master key(s).

## Reference-level Explanation

The `0003-awses-message-encryption-generate.py` script in this package will generate a manifest that describes
the below test cases and references the keys manifest generated by `0002-keys-generate.py`. This
should be treated as the canonical AWS Encryption SDK message encryption manifest file, defining
all message encryption test vectors that a complete implementation must be able to generate.

### Contents

### manifest

Map identifying the manifest.

-   `type` : Identifies the manifest as an AWS Encryption SDK message encryption manifest.
    -   Must be `awses-encrypt`
-   `version` : Identifies the version of this feature document that describes the manifest.

#### keys

URI identifying a [keys manifest](./0002-keys.md) to use with all tests.

#### plaintexts

Map of plaintext names to size in bytes.

These plaintexts will be generated by the handler and should be random byte vectors of the specified
number of bytes.

#### tests

Map object mapping a test case ID to a test case description that describes how to generate a
test vector.

-   `plaintext` : Plaintext source name
-   `algorithm` : Hex string of supported [Algorithm ID](http://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/algorithms-def.html)
-   `frame-size` : Frame size in bytes (0 for nonframed)
-   `encryption-context` : Map of keys and values to use for encryption context
-   `master-keys` : List of Master Key descriptions as defined in [0005-awses-master-key](./0005-awses-master-key.md)

### Scenarios to test

These are a set of scenarios that we know we want to test for all implementations. The `0003-awses-message-encryption-generate.py`
script will generate a manifest that correctly describes these scenarios.

#### Algorithm Suites

-   Every [Algorithm Suite supported by the AWS Encryption SDK](https://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/algorithms-reference.html)

#### Framing

-   Non-framed message
-   Framed message with frame size smaller than plaintext size
-   Framed message with frame size equal to plaintext size
-   Framed message with frame size larger than plaintext size
-   Framed message with >10 frames

#### Encryption Context

-   Message without encryption context
-   Message with encryption context
-   Unicode values in encryption context
-   No unicode values in encryption context

#### Master Key Providers

-   Single AWS KMS MasterKey that can be decrypted by all consumers
-   Multiple AWS KMS MasterKeys of which only one can be decrypted by all consumers
-   Single AES Symmetric Raw MasterKey that can be decrypted
-   Multiple Symmetric Raw MasterKeys of which only one can be decrypted
-   Single RSA Asymmetric Raw MasterKey that can be decrypted
-   Multiple Asymmetric Raw MasterKeys of which only one can be decrypted

### Example

```json
{
    "manifest": {
        "type": "awses-encrypt",
        "version": 1
    },
    "keys": "file://relative/file/path.json",
    "plaintexts": {
        "small": 1024
    },
    "tests": {
        "2d1e0da9-74f8-4817-842d-c2b973abed7c": {
            "plaintext": "small",
            "algorithm": "0014",
            "frame-size": 1024,
            "encryption-context": {},
            "master-keys": [
                {
                    "type": "raw",
                    "provider-id": "aws-raw-vectors-persistant",
                    "key": "rsa-4096-private",
                    "encryption-algorithm": "rsa",
                    "padding-algorithm": "oaep-mgf1",
                    "padding-hash": "sha256"
                }
            ]
        },
        "f7f3416b-7527-4108-8d15-6d0d5a377a2c": {
            "plaintext": "small",
            "algorithm": "0378",
            "frame-size": 500,
            "encryption-context": {
                "classification": "secret squirrel",
                "nuts": "acorn"
            },
            "master-keys": [
                {
                    "type": "aws-kms",
                    "key": "us-west-2-decryptable"
                },
                {
                    "type": "aws-kms",
                    "key": "us-west-2-encrypt-only"
                }
            ]
        }
    }
}
```
